<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="./start-tutorial.html">
<link rel="import" href="./tutorial-level-route.html">
<link rel="import" href="./coming-soon.html">

<dom-module id="polymor-tutorial-game-app">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <app-location route="{{_route}}">
        </app-location>

        <app-route
            route="{{_route}}"
            pattern="/app/:level"
            data="{{_routeData}}"
            tail="{{_subroute}}">
        </app-route>

        <iron-pages
            selected="[[_routeData.level]]"
            attr-for-selected="level"
            selected-attribute="visible"
            fallback-selection="start"
            role="main">

            <start-tutorial level="start"></start-tutorial>

            <tutorial-level-route level="1" part="[[_selectedPart]]"></tutorial-level-route>
            <tutorial-level-route level="2" part="[[_selectedPart]]"></tutorial-level-route>
            <tutorial-level-route level="3" part="[[_selectedPart]]"></tutorial-level-route>
            <tutorial-level-route level="4" part="[[_selectedPart]]"></tutorial-level-route>

            <coming-soon level="soon"></coming-soon>

        </iron-pages>
    </template>

    <script>

        class PolymorTutorialGameApp extends Polymer.Element {
            static get is() {
                return 'polymor-tutorial-game-app';
            }

            static get properties() {
                return {
                    _route: {
                        type: String,
                        value: '',
                    },
                    _routeData: {
                        type: Object,
                        value: {},
                    },
                    _selectedPart: {
                        type: Number,
                        computed: '_computePartFrom(_subroute.path)',
                    },
                    _subroute: {
                        type: Object,
                        value: {},
                    },
                    _ready: {
                        type: Boolean,
                        value: false,
                    },
                    _localStorageKey: {
                        type: String,
                        value: 'polymerTutorialGame'
                    }
                };
            }

            static get observers() {
                return [
                    '_routeChanged(_route.path)',
                ]
            }

            _routeChanged(updatedRoutePath) {
                if (this._ready) {
                    this._updateCurrentLevelInLocalStorage(updatedRoutePath);
                }
            }

            _computePartFrom(subroutePath) {
                if (/\/\d\//.test(subroutePath)) {
                    return Number(subroutePath.slice(1, subroutePath.length - 1));
                }

                return 0;
            }

            ready() {
                super.ready();


                if (this._route.path === "/" || this._route.path.indexOf("-") > 0) {
                    this.set('_route.path', this._getCurrentLevelFromLocalStorage().replace("-", "/"));
                }

                this._ready = true;
                this._updateCurrentLevelInLocalStorage(this._route.path);
            }

            _getCurrentLevelFromLocalStorage() {
                const polymerTutorialInformation = this._getPolymerTutorialGameObjectFromStorage();
                return !!polymerTutorialInformation ? polymerTutorialInformation.currentLevel : '/app/start/';
            }

            _updateCurrentLevelInLocalStorage(routePath) {
                window.localStorage.setItem(this._localStorageKey, JSON.stringify({currentLevel: routePath}));
            }

            _getPolymerTutorialGameObjectFromStorage() {
                return JSON.parse(window.localStorage.getItem(this._localStorageKey));
            }
        }

        window.customElements.define(PolymorTutorialGameApp.is, PolymorTutorialGameApp);
    </script>
</dom-module>
